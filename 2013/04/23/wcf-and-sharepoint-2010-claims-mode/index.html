<!DOCTYPE HTML>
<html>
<head>
  <meta charset="utf-8">
  
  <title>WCF and Sharepoint 2010 Claims mode | Debajyoti Mahanta</title>
  <meta name="author" content="Debajyoti Mahanta">
  
  <meta name="description" content="For the past two days i have been working on moving an existing Sharepoint application from 2010 to 2013 in 2010 mode. What this means that it will ru">
  
  
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

  <meta property="og:title" content="WCF and Sharepoint 2010 Claims mode"/>
  <meta property="og:site_name" content="Debajyoti Mahanta"/>

  
    <meta property="og:image" content="undefined"/>
  

  <link href="/favicon.png" rel="icon">

  <link rel="alternate" href="/atom.xml" title="Debajyoti Mahanta" type="application/atom+xml">

  <link rel="stylesheet" href="/css/style.css" media="screen" type="text/css">
  <link rel="stylesheet" href="/css/print.css" media="print" type="text/css">

  <!--[if lt IE 9]><script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script><![endif]-->

  <script src="//ajax.googleapis.com/ajax/libs/jquery/1.8/jquery.min.js"></script>

  <script src="/js/scripts.js"></script>

  
  
    <script type="text/x-mathjax-config">
  MathJax.Hub.Config(
    {
      tex2jax: {inlineMath: [['$','$'], ['\(','\)']]},
      TeX: {equationNumbers: {autoNumber: ["AMS"], useLabelIds: true}},
    }
  );
</script>
<script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>

  
</head>


<body>
    <div class="container">
      <div class="left-col">
        <div class="intrude-less">
          <header id="header" class="inner">
            <div class="profilepic">
  <script src="/js/md5.js"></script>
  <script type="text/javascript">
    $(function(){
	$('.profilepic').append(
          "<img src='http://www.gravatar.com/avatar/"
          + MD5("")
          + "?s=160' alt='Profile Picture' style='width: 160px;' />");
    });
  </script>
</div><!-- profilepic -->
<h1><a href="/">Debajyoti Mahanta</a></h1>
<nav id="main-nav">
  <ul class="main">
    
      <li>
      <a href="/about">About</a>
      </li>
    
  </ul>
  
</nav><!-- main-nav -->
<nav id="sub-nav">
  <div class="social">
    
      <a class="google" href="http://plus.google.com/debajyoti.mahanta"
         title="Google+">Google+</a>
    
    
      <a class="twitter" href="http://twitter.com/dmahanta"
         title="Twitter">Twitter</a>
    
    
      <a class="github" href="http://github.com/debajyotimahanta"
         title="Github">Github</a>
    
    
        <a class="rss" href="/atom.xml" title="RSS">RSS</a>
    
  </div>
</nav><!-- sub-nav -->
<nav id="widget-nav">
  <div class="widgets">
    
      
<div class="widget tag">
  <h3 class="title">標籤</h3>
  <ul class="entry">
  
    <li><a href="/tags/C-Nancy-Security-NET/">C# Nancy Security .NET</a><small>1</small></li>
  
    <li><a href="/tags/CI/">CI</a><small>1</small></li>
  
    <li><a href="/tags/DIY/">DIY</a><small>1</small></li>
  
    <li><a href="/tags/IoT/">IoT</a><small>1</small></li>
  
    <li><a href="/tags/SOA/">SOA</a><small>1</small></li>
  
    <li><a href="/tags/Security/">Security</a><small>1</small></li>
  
    <li><a href="/tags/SharePoint-2013-Apps-Security-cross-site/">SharePoint 2013 Apps Security cross-site</a><small>1</small></li>
  
    <li><a href="/tags/Sharepoint2013-Sharepoint-ManagedMetadataService/">Sharepoint2013 Sharepoint ManagedMetadataService</a><small>1</small></li>
  
    <li><a href="/tags/WCF-Sharepoint2010-ClaimsBasedAuthentication-Sharepoint2013-C-Sharepoint/">WCF Sharepoint2010 ClaimsBasedAuthentication Sharepoint2013 C# Sharepoint</a><small>1</small></li>
  
    <li><a href="/tags/XHR/">XHR</a><small>1</small></li>
  
    <li><a href="/tags/ajax/">ajax</a><small>1</small></li>
  
    <li><a href="/tags/angularjs/">angularjs</a><small>1</small></li>
  
    <li><a href="/tags/api/">api</a><small>1</small></li>
  
    <li><a href="/tags/aws/">aws</a><small>2</small></li>
  
    <li><a href="/tags/azure/">azure</a><small>1</small></li>
  
    <li><a href="/tags/bower/">bower</a><small>1</small></li>
  
    <li><a href="/tags/clientside/">clientside</a><small>1</small></li>
  
    <li><a href="/tags/cloud/">cloud</a><small>1</small></li>
  
    <li><a href="/tags/coffescript/">coffescript</a><small>1</small></li>
  
    <li><a href="/tags/devops/">devops</a><small>1</small></li>
  
    <li><a href="/tags/grunt/">grunt</a><small>1</small></li>
  
    <li><a href="/tags/gulp/">gulp</a><small>1</small></li>
  
    <li><a href="/tags/hardware/">hardware</a><small>1</small></li>
  
    <li><a href="/tags/ionic/">ionic</a><small>1</small></li>
  
    <li><a href="/tags/iot/">iot</a><small>1</small></li>
  
    <li><a href="/tags/javascript/">javascript</a><small>5</small></li>
  
    <li><a href="/tags/jquery/">jquery</a><small>1</small></li>
  
    <li><a href="/tags/lync/">lync</a><small>1</small></li>
  
    <li><a href="/tags/microsfot/">microsfot</a><small>1</small></li>
  
    <li><a href="/tags/node/">node</a><small>2</small></li>
  
    <li><a href="/tags/node-js/">node.js</a><small>1</small></li>
  
    <li><a href="/tags/opensource/">opensource</a><small>1</small></li>
  
    <li><a href="/tags/raspberry-pi/">raspberry pi</a><small>1</small></li>
  
    <li><a href="/tags/sharepoint-html/">sharepoint.html</a><small>1</small></li>
  
  </ul>
</div>


    
  </div>
</nav><!-- widget-nav -->

          <header>
        </div><!-- intrude-less -->
      </div><!-- left-col -->
      <div class="mid-col">
        <div class="mid-col-container">
	    <div id="content" class="inner"><article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  
	<div class="meta">
          
<div class="date">

<time datetime="2013-04-24T04:05:00.000Z"
      
      data-updated="true"
       itemprop="datePublished">
  2013-04-23
</time>





</div>

          
          
<div class="print">打印</div>

          
	</div>
        <h1 class="title" itemprop="name">WCF and Sharepoint 2010 Claims mode</h1>
      	<div class="entry-content" itemprop="articleBody"><p>For the past two days i have been working on moving an existing Sharepoint application from 2010 to 2013 in <a href="http://technet.microsoft.com/en-us/library/jj219599.aspx" target="_blank" rel="external">2010 mode</a>. What this means that it will run under the 14 hives in 2013 and wont use the new 15 hive. </p>
<p>However our old application was using <a href="http://technet.microsoft.com/en-us/library/cc262350.aspx#planwin" target="_blank" rel="external">windows based authentication</a>, however in the new system it uses <a href="http://technet.microsoft.com/en-us/library/cc262350.aspx#cba" target="_blank" rel="external">claims based authentication</a>. I am familiar with how claims work, but as soon as we start to mix it up with WCF, it gets fairly complicated because internal i think windows tries to setup handshake using NTLM, which defines the general concept of claims, because i dont have to use OAuth or SAML to explicitly get a token and pass it. I think windows does it for me as long as i am passing the username and password. </p>
<h1 id="Server_Side_Code">Server Side Code</h1><p>On the server side all i am doing is creating a WCF service and binding it to a basic http bidning and setting the transport to use credientail only. This is what it looks like<br>    [BasicHttpBindingServiceMetadataExchangeEndpoint]<br>    [AspNetCompatibilityRequirements(RequirementsMode = AspNetCompatibilityRequirementsMode.Required)]<br>    public class DocumentService : IDocumentService<br>    {<br>    ……<br>    }<br>Note the attributes for the class. Why it is important is because it enables us to expose the webservice without the need to define any end points. You can access the service via …filename.svc/MEX.</p>
<p>Thats all that is to the server side. We package it and deploy it to the Webserver. Its a common mistake to go and append setting to the web.config.As long as we using this attribute we do not need to define anything.</p>
<h1 id="Client_Side_Code">Client Side Code</h1><p>On the client side, all we need to is config it to pass the credientails. The way i have done this is as show below. Nothing fancy, just defining the endpoint and passing the username and password and allow impersonation<br><figure class="highlight smali"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">BasicHttpBinding binding =<span class="instruction"> new </span>BasicHttpBinding(<span class="function">)</span>;</span><br><span class="line">binding.Security.Mode = BasicHttpSecurityMode.TransportCredentialOnly;</span><br><span class="line">binding.Security.Transport.ClientCredentialType = HttpClientCredentialType.Ntlm;</span><br><span class="line"></span><br><span class="line">EndpointAddress endpoint =</span><br><span class="line">   <span class="instruction"> new </span>EndpointAddress(@<span class="string">"http://localhost:36150/_vti_bin/SharePointBits/Sample.svc"</span><span class="function">)</span>;</span><br><span class="line"></span><br><span class="line">// create our proxy client</span><br><span class="line">WCFService.SampleServiceClient proxy = </span><br><span class="line">   <span class="instruction"> new </span>WCFService.SampleServiceClient(binding, endpoint<span class="function">)</span>;</span><br><span class="line">proxy.ClientCredentials.Windows.ClientCredential =<span class="instruction"> new </span>System.Net.NetworkCredential(<span class="string">"administrator"</span>, <span class="string">"Pass@word!"</span>, <span class="string">"spod-10-3"</span><span class="function">)</span>;</span><br><span class="line">proxy.ClientCredentials.Windows.AllowedImpersonationLevel = </span><br><span class="line">    System.Security.Principal.TokenImpersonation<span class="class">Level.Impersonation;</span></span><br><span class="line"></span><br><span class="line">//<span class="instruction"> invoke </span>our service</span><br><span class="line">string webUrl =<span class="function"> proxy.GetCurrentWebUrl(</span><span class="function">)</span>;</span><br><span class="line"></span><br><span class="line">Console.WriteLine(webUrl<span class="function">)</span>;</span><br><span class="line">Console.Read(<span class="function">)</span>;</span><br></pre></td></tr></table></figure></p>
<h2 id="Client_side_HTTP_traffic">Client side HTTP traffic</h2><p>I wanted to find out if the username and password is passed anywhere i fired up fiddler and checked what happens. I couldnt find anywhere refernce to username and password. So i looked up how NTLM works, and i think its trying to setup the trust using the AD account without passing the username and password. What it does pass is an NTLM token as shown in the SOAP request below<br>    POST <a href="http://spod-10-3:36150/_vti_bin/DocumentService.svc" target="_blank" rel="external">http://spod-10-3:36150/_vti_bin/DocumentService.svc</a> HTTP/1.1<br>    Content-Type: text/xml; charset=utf-8<br>    VsDebuggerCausalityData: uIDPo6oB9/O+EI5CqGe+xNjxE9QAAAAAnWBGldw3JU6dLCIhF5AQZKfaxLYBlLBDp/UBO3q1DKAACQAA<br>    SOAPAction: “<a href="http://tempuri.org/IDocumentService/HelloWorld" target="_blank" rel="external">http://tempuri.org/IDocumentService/HelloWorld</a>“<br>    Authorization: NTLM TlRMTVNTUAABAAAAt4II4gAAAAAAAAAAAAAAAAAAAAAGAbEdAAAADw==<br>    Host: spod-10-3:36150<br>    Content-Length: 0<br>Look at the <strong>Authorization</strong> param. Its an NTLM token. However i couldnt find any kind of SAML or OAuth request being done, so i guess AD is verifying the username and password</p>
</div>


</article>

  <div class="share">
  <div class="addthis_toolbox addthis_default_style ">
  
  
  <a class="addthis_button_tweet"></a>
  
  
  <a class="addthis_button_google_plusone" g:plusone:size="medium"></a>
  
  
  </div>
  <script type="text/javascript">
    var addthis_config = {"data_track_addressbar":true};
  </script>
  <script type="text/javascript"
          src="http://s7.addthis.com/js/250/addthis_widget.js#pubid=null">
  </script>
</div>




</div>
	</div>
        <footer id="footer" class="inner">
          Copyright © 2013 - Debajyoti Mahanta - Powered by <a href="https://github.com/tommy351/hexo">Hexo</a><br>
- Ported theme <a href="https://github.com/nuklly/hexo-theme-greyshade">GreyShade</a> -
        </footer>
        
<script src="/js/slash.js"></script>
<script src="/js/jquery.imagesloaded.min.js"></script>
<script src="/js/gallery.js"></script>







<link rel="stylesheet" href="/fancybox/jquery.fancybox.css" media="screen" type="text/css">
<script src="/fancybox/jquery.fancybox.pack.js"></script>
<script type="text/javascript">
(function($){
  $('.fancybox').fancybox();
})(jQuery);
</script>




      </div><!-- mid-col -->
    </div><!-- container -->
</body>
</html>
